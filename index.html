<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PitPat Treadmill Control (Web Bluetooth)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f8f9fa; }
        h1 { margin-bottom: 1em; }
        .dashboard { display: flex; flex-wrap: wrap; gap: 1em; margin-bottom: 1em; }
        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 1em 2em;
            min-width: 160px;
            flex: 1 1 160px;
            text-align: center;
        }
        .card-title { font-size: 1.1em; color: #888; }
        .card-value { font-size: 2em; margin-top: 0.2em; }
        .controls { display: flex; gap: 1em; margin-bottom: 1em; }
        .slider-group { margin: 1em 0; }
        .slider-label { margin-bottom: 0.5em; display: block; }
        #status { margin-top: 1em; }
        button:disabled { opacity: 0.6; }
        .alert { background: #f8d7da; color: #721c24; padding: 0.7em 1em; border-radius: 5px; margin-bottom: 1em; display: none; }
        .alert.open { display: block; }
    </style>
</head>
<body>
    <h1>PitPat Treadmill Control</h1>
    <div id="alert" class="alert"></div>
    <div class="controls">
        <input id="deviceNameInput" type="text" placeholder="Device Name (optional)" style="flex:1;">
        <button id="connectBtn">Connect</button>
    </div>
    <div class="dashboard">
        <div class="card"><div class="card-title">Speed</div><div class="card-value" id="speed">-</div></div>
        <div class="card"><div class="card-title">Distance</div><div class="card-value" id="distance">-</div></div>
        <div class="card"><div class="card-title">Calories</div><div class="card-value" id="calories">-</div></div>
        <div class="card"><div class="card-title">Steps</div><div class="card-value" id="steps">-</div></div>
        <div class="card"><div class="card-title">Duration</div><div class="card-value" id="duration">-</div></div>
        <div class="card"><div class="card-title">Running State</div><div class="card-value" id="statusCard">-</div></div>
    </div>
    <div class="controls">
        <button id="startBtn" disabled>Start</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="speedDownBtn" disabled>Speed Down</button>
        <button id="speedUpBtn" disabled>Speed Up</button>
    </div>
    <div class="slider-group">
        <label class="slider-label" for="speedSlider">Set Speed (kph): <span id="sliderValue">0</span></label>
        <input type="range" id="speedSlider" min="0" max="6" step="0.1" value="0" style="width: 300px;">
    </div>
    <div id="status">Status: Not connected</div>

    <script>
        // --- Bluetooth UUIDs ---
        const SERVICE_UUID = "0000fba0-0000-1000-8000-00805f9b34fb";
        const NOTIFY_CHAR_UUID = "0000fba2-0000-1000-8000-00805f9b34fb";
        const WRITE_CHAR_UUID = "0000fba1-0000-1000-8000-00805f9b34fb";

        // --- UI Elements ---
        const connectBtn = document.getElementById('connectBtn');
        const deviceNameInput = document.getElementById('deviceNameInput');
        const alertDiv = document.getElementById('alert');
        const statusDiv = document.getElementById('status');
        const speedDiv = document.getElementById('speed');
        const distanceDiv = document.getElementById('distance');
        const caloriesDiv = document.getElementById('calories');
        const stepsDiv = document.getElementById('steps');
        const durationDiv = document.getElementById('duration');
        const statusCardDiv = document.getElementById('statusCard');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const speedUpBtn = document.getElementById('speedUpBtn');
        const speedDownBtn = document.getElementById('speedDownBtn');
        const speedSlider = document.getElementById('speedSlider');
        const sliderValue = document.getElementById('sliderValue');

        // --- State ---
        let device = null;
        let server = null;
        let notifyChar = null;
        let writeChar = null;
        let treadmillData = {};
        let connected = false;
        let runningState = 3; // 0: Starting, 1: Running, 2: Paused, 3: Stopped
        let curTargetSpeed = 1000; // in treadmill units

        // --- Helper Functions ---
        function showAlert(msg) {
            alertDiv.textContent = msg;
            alertDiv.classList.add('open');
        }
        function hideAlert() {
            alertDiv.classList.remove('open');
        }
        function setStatus(msg) {
            statusDiv.textContent = "Status: " + msg;
        }
        function updateDashboard(data) {
            speedDiv.textContent = data.speed || '-';
            distanceDiv.textContent = data.distance || '-';
            caloriesDiv.textContent = data.calories || '-';
            stepsDiv.textContent = data.steps || '-';
            durationDiv.textContent = data.duration || '-';
            statusCardDiv.textContent = data.status || '-';
        }
        function enableControls(enable) {
            startBtn.disabled = !enable;
            stopBtn.disabled = !enable;
            speedUpBtn.disabled = !enable;
            speedDownBtn.disabled = !enable;
            speedSlider.disabled = !enable;
        }
        function updateRunningState(state) {
            runningState = state;
            if (!connected) {
                enableControls(false);
                startBtn.textContent = "Start";
            } else {
                switch (state) {
                    case 0: // Starting
                        enableControls(false);
                        startBtn.textContent = "Start";
                        break;
                    case 1: // Running
                        enableControls(true);
                        startBtn.textContent = "Pause";
                        break;
                    case 2: // Paused
                        enableControls(true);
                        startBtn.textContent = "Start";
                        break;
                    case 3: // Stopped
                        enableControls(true);
                        startBtn.textContent = "Start";
                        break;
                    default:
                        enableControls(false);
                        startBtn.textContent = "Start";
                }
            }
        }

        // --- Send Data Logic (replaces sendCommand) ---
        let pendingData = null;
        function send_data(packet) {
            pendingData = packet;
        }

        // --- Bluetooth Logic ---
        async function connectBluetooth() {
            hideAlert();
            setStatus("Requesting device...");
            try {
                console.log("Requesting Bluetooth device...");
                device = await navigator.bluetooth.requestDevice({
                    filters: deviceNameInput.value ? [{ name: deviceNameInput.value, services: [SERVICE_UUID] }] : [{ services: [SERVICE_UUID] }],
                    services: [SERVICE_UUID]
                });
                console.log("Device selected:", device);
                setStatus("Connecting...");
                device.addEventListener('gattserverdisconnected', onDisconnected);
                server = await device.gatt.connect();
                console.log("GATT server connected:", server);
                let services = await server.getPrimaryServices();
                console.log("Primary services:", services.map(s => s.uuid));
                notifyChar = await server.getPrimaryService(SERVICE_UUID).then(
                    service => service.getCharacteristic(NOTIFY_CHAR_UUID)
                ).catch(async () => {
                    // fallback: try to find the service by iterating
                    let services = await server.getPrimaryServices();
                    for (let s of services) {
                        try {
                            let c = await s.getCharacteristic(NOTIFY_CHAR_UUID);
                            if (c) return c;
                        } catch {}
                    }
                    throw new Error("Notify characteristic not found");
                });
                console.log("Notify characteristic:", notifyChar);
                writeChar = await server.getPrimaryService(SERVICE_UUID).then(
                    service => service.getCharacteristic(WRITE_CHAR_UUID)
                ).catch(async () => {
                    let services = await server.getPrimaryServices();
                    for (let s of services) {
                        try {
                            let c = await s.getCharacteristic(WRITE_CHAR_UUID);
                            if (c) return c;
                        } catch {}
                    }
                    throw new Error("Write characteristic not found");
                });
                console.log("Write characteristic:", writeChar);
                await notifyChar.startNotifications();
                notifyChar.addEventListener('characteristicvaluechanged', handleNotification);
                connected = true;
                setStatus("Connected to " + (device.name || "device"));
                connectBtn.textContent = "Disconnect";
                deviceNameInput.disabled = true;
                updateRunningState(3);
                // No heartbeat loop, just send heartbeat or data on notification
            } catch (err) {
                console.error("Bluetooth connection error:", err);
                showAlert("Bluetooth error: " + err);
                setStatus("Not connected");
                connected = false;
                connectBtn.textContent = "Connect";
                deviceNameInput.disabled = false;
                // stopHeartbeatLoop();
            }
        }

        function disconnectBluetooth() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            // No heartbeat loop to stop
        }

        function onDisconnected() {
            connected = false;
            setStatus("Disconnected");
            connectBtn.textContent = "Connect";
            deviceNameInput.disabled = false;
            updateRunningState(3);
            showAlert("Disconnected from device.");
            // No heartbeat loop to stop
        }

        function handleNotification(event) {
            const value = event.target.value;
            // Logging for debugging
            console.log("Received notification, byteLength:", value.byteLength);
            let hexStr = [];
            for (let i = 0; i < value.byteLength; ++i) {
                hexStr.push(value.getUint8(i).toString(16).padStart(2, "0"));
            }
            console.log("Payload (hex):", hexStr.join(" "));
            // Parse treadmill data from value (see treadmill_data.py for structure)
            if (value.byteLength < 31) {
                treadmillData = {
                    speed: "-",
                    distance: "-",
                    calories: "-",
                    steps: "-",
                    duration: "-",
                    status: "Invalid"
                };
                updateDashboard(treadmillData);
                updateRunningState(3);
                return;
            }
            // Helper to read unsigned int from bytes
            function u16(offset) {
                return (value.getUint8(offset) << 8) | value.getUint8(offset + 1);
            }
            function u32(offset) {
                return (value.getUint8(offset) << 24) | (value.getUint8(offset + 1) << 16) | (value.getUint8(offset + 2) << 8) | value.getUint8(offset + 3);
            }
            // Parse fields
            const current_speed = u16(3);
            const distance = u32(7);
            const calories = (value.getUint8(18) << 8) | value.getUint8(19);
            const steps = u32(14);
            const duration = u32(20);
            const flags = value.getUint8(26);
            const unit_mode = (flags & 128) === 128 ? 1 : 0;
            const running_state_bits = flags & 24;
            let running_state = 3;
            if (running_state_bits === 24) running_state = 0;
            else if (running_state_bits === 8) running_state = 1;
            else if (running_state_bits === 16) running_state = 2;
            else running_state = 3;
            const statusArr = ["Starting", "Running", "Paused", "Stopped"];
            const speed_unit = unit_mode === 1 ? "mph" : "kph";
            const distance_unit = unit_mode === 1 ? "mi" : "km";
            treadmillData = {
                speed: (current_speed / 1000).toFixed(2) + " " + speed_unit,
                distance: (distance / 1000).toFixed(2) + " " + distance_unit,
                calories: calories + " kcal",
                steps: steps,
                duration: (duration / 1000).toFixed(1) + " s",
                status: statusArr[running_state] || "Unknown"
            };
            // Log parsed fields
            console.log("Parsed treadmill data:", treadmillData);
            updateDashboard(treadmillData);
            updateRunningState(running_state);

            // --- Heartbeat/data send logic, like _notification_handler ---
            if (writeChar) {
                if (pendingData) {
                    console.log("Sending pending data packet:", Array.from(pendingData).map(b => b.toString(16).padStart(2, "0")).join(" "));
                    writeChar.writeValue(pendingData).then(() => {
                        console.log("Pending data sent.");
                        pendingData = null;
                    }).catch(err => {
                        console.error("Failed to send pending data:", err);
                    });
                } else {
                    // Heartbeat packet: 6a05fdf843
                    const heartbeat = new Uint8Array([0x6a, 0x05, 0xfd, 0xf8, 0x43]);
                    console.log("Sending heartbeat packet:", Array.from(heartbeat).map(b => b.toString(16).padStart(2, "0")).join(" "));
                    writeChar.writeValue(heartbeat).catch(err => {
                        console.error("Failed to send heartbeat:", err);
                    });
                }
            }
        }

        async function sendCommand(packet) {
            if (!writeChar) return;
            try {
                console.log("Sending command packet:", Array.from(packet).map(b => b.toString(16).padStart(2, "0")).join(" "));
                await writeChar.writeValue(packet);
            } catch (err) {
                console.error("Failed to send command:", err);
                showAlert("Failed to send command: " + err);
            }
        }

        // --- Command Packet Generators (see treadmill_controller.py) ---
        /**
         * Constructs a treadmill command packet.
         * @param {string} type - Command type: "start", "pause", "stop", or "set_speed".
         * @param {number} [speed=1000] - Target speed in treadmill units (integer, 1000 = 1.00 kph, range: 1000 to 6000).
         * @returns {Uint8Array} The command packet.
         */
        function makePacket(type, speed = 1000) {
            // type: "start", "pause", "stop", "set_speed"
            // Implements the protocol from treadmill_controller.py
            let arr = new Uint8Array(23);
            arr[0] = 0x6A; // START_BYTE
            arr[1] = 0x17; // LENGTH
            // arr[2-5] = 0 (reserved)
            arr[6] = (speed >> 8) & 0xFF;
            arr[7] = speed & 0xFF;
            arr[8] = type === "set_speed" ? 5 : 1; // magical_i11: 5 for set_speed, 1 for others
            arr[9] = 0; // incline
            arr[10] = 80; // weight (default)
            arr[11] = 0; // reserved
            // Command byte (kph): 4=start/set, 2=pause, 0=stop
            let cmd = type === "pause" ? 2 : type === "stop" ? 0 : 4;
            arr[12] = cmd & 0xF7; // kph mode (bit 3 = 0)
            // User ID (8 bytes, default 58965456623)
            let userId = 58965456623n;
            for (let i = 0; i < 8; ++i) {
                arr[13 + i] = Number((userId >> BigInt(56 - i * 8)) & 0xFFn);
            }
            // Checksum: XOR of bytes 1 to 20
            let checksum = 0;
            for (let i = 1; i <= 20; ++i) {
                checksum ^= arr[i];
            }
            arr[21] = checksum;
            arr[22] = 0x43; // END_BYTE
            return arr;
        }

        // --- UI Event Handlers ---
        connectBtn.addEventListener('click', () => {
            if (!connected) connectBluetooth();
            else disconnectBluetooth();
        });

        startBtn.addEventListener('click', () => {
            if (!connected) return;
            if (runningState === 1) { // Running -> Pause
                send_data(makePacket("pause"));
            } else { // Start
                send_data(makePacket("start", curTargetSpeed));
            }
        });

        stopBtn.addEventListener('click', () => {
            if (!connected) return;
            send_data(makePacket("stop"));
        });

        speedUpBtn.addEventListener('click', () => {
            if (!connected) return;
            curTargetSpeed = Math.min(curTargetSpeed + 100, 6000);
            send_data(makePacket("set_speed", curTargetSpeed));
        });

        speedDownBtn.addEventListener('click', () => {
            if (!connected) return;
            curTargetSpeed = Math.max(curTargetSpeed - 100, 1000);
            send_data(makePacket("set_speed", curTargetSpeed));
        });

        speedSlider.addEventListener('input', () => {
            sliderValue.textContent = speedSlider.value;
        });
        speedSlider.addEventListener('change', () => {
            if (!connected) return;
            curTargetSpeed = Math.round(parseFloat(speedSlider.value) * 1000);
            send_data(makePacket("set_speed", curTargetSpeed));
        });

        // --- Initialize ---
        updateDashboard({});
        updateRunningState(3);
        sliderValue.textContent = speedSlider.value;
    </script>
</body>
</html>
